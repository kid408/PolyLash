# 敌人系统详解

## 目录
- [敌人类型](#敌人类型)
- [敌人属性](#敌人属性)
- [特殊机制](#特殊机制)
- [AI系统](#ai系统)
- [波次增强](#波次增强)

---

## 敌人类型

游戏中共有5种敌人类型，每种都有独特的特性和战斗风格：

### 1. 基础敌人 (NORMAL)
**enemy_id**: `basic_enemy`

最基础的敌人类型，平衡的属性，适合新手玩家熟悉游戏。

**基础属性**:
- 生命值: 100
- 移动速度: 150
- 攻击力: 10
- 攻击范围: 50
- 攻击冷却: 1.0秒
- 经验值: 10
- 金币值: 5
- 击退抗性: 0.5
- 能量掉落: 5

**特点**:
- 无特殊能力
- 直线追逐玩家
- 受到群聚AI影响（会与其他敌人保持距离）

---

### 2. 快速敌人 (NORMAL)
**enemy_id**: `fast_enemy`

速度极快但脆弱的敌人，擅长快速接近玩家。

**基础属性**:
- 生命值: 50 (最低)
- 移动速度: 300 (最快)
- 攻击力: 5
- 攻击范围: 40
- 攻击冷却: 0.5秒
- 经验值: 15
- 金币值: 8
- 击退抗性: 0.3 (最低)
- 能量掉落: 3

**特点**:
- 移动速度是基础敌人的2倍
- 生命值低，容易被击杀
- 击退抗性低，容易被击退
- 适合用范围武器清理

---

### 3. 坦克敌人 (NORMAL)
**enemy_id**: `tank_enemy`

血量厚、伤害高的重型敌人，移动缓慢但难以击杀。

**基础属性**:
- 生命值: 300 (最高)
- 移动速度: 100 (最慢)
- 攻击力: 20 (高)
- 攻击范围: 60
- 攻击冷却: 2.0秒
- 经验值: 30
- 金币值: 15
- 击退抗性: 0.9 (最高)
- 能量掉落: 15

**特点**:
- 生命值是基础敌人的3倍
- 击退抗性极高，难以击退
- 移动缓慢，容易躲避
- 击杀后获得大量奖励

---

### 4. Boss敌人 (NORMAL)
**enemy_id**: `boss_enemy`

终极挑战，拥有最高的生命值和伤害。

**基础属性**:
- 生命值: 1000 (极高)
- 移动速度: 120
- 攻击力: 50 (极高)
- 攻击范围: 80
- 攻击冷却: 1.5秒
- 经验值: 100
- 金币值: 50
- 击退抗性: 1.0 (完全免疫)
- 能量掉落: 50

**特点**:
- 完全免疫击退
- 生命值是基础敌人的10倍
- 攻击力是基础敌人的5倍
- 击杀后获得巨额奖励

---

### 5. 地雷怪 (MINE_LAYER)
**enemy_id**: `mine_layer`
**enemy_type**: `EnemyType.MINE_LAYER`

特殊敌人，死后会在原地留下持续伤害的毒池。

**基础属性**:
- 生命值: 80
- 移动速度: 120
- 攻击力: 8
- 攻击范围: 45
- 攻击冷却: 1.2秒
- 经验值: 12
- 金币值: 6
- 击退抗性: 0.4
- 能量掉落: 4
- 颜色: 绿色 (RGB: 0.5, 1.0, 0.5)

**特殊能力 - 毒池**:
- 死亡时在原地生成毒池
- 毒池半径: 60像素
- 持续时间: 8秒
- 伤害频率: 每0.5秒造成5点伤害
- 视觉效果: 半透明绿色圆形区域
- 玩家进入毒池范围会持续受到伤害

**战术建议**:
- 远程击杀，避免近战
- 注意死亡位置，不要在狭窄区域击杀
- 毒池会阻断玩家移动路线

---

## 敌人属性

### 核心属性说明

| 属性 | 说明 | 影响 |
|------|------|------|
| health | 生命值 | 决定敌人能承受多少伤害 |
| speed | 移动速度 | 影响追逐玩家的速度 |
| damage | 攻击力 | 对玩家造成的伤害 |
| attack_range | 攻击范围 | 能够攻击玩家的距离 |
| attack_cooldown | 攻击冷却 | 两次攻击之间的间隔 |
| xp_value | 经验值 | 击杀后获得的经验 |
| gold_value | 金币值 | 击杀后获得的金币 |
| knockback_resistance | 击退抗性 | 0.0-1.0，越高越难击退 |
| energy_drop | 能量掉落 | 击杀后获得的能量值 |

### 颜色配置

部分敌人可以配置自定义颜色（通过CSV的color_r, color_g, color_b列）：
- 地雷怪: 绿色 (0.5, 1.0, 0.5)
- 其他敌人: 使用默认白色

---

## 特殊机制

### 1. 硬壳龟 (SHIELDED)
**enemy_type**: `EnemyType.SHIELDED`

拥有护盾的特殊敌人，能够减免伤害并反伤玩家。

**护盾机制**:
- 受到玩家伤害时，减免70%伤害（只受到30%伤害）
- 同时对玩家造成1点反伤
- 显示"SHIELD!"浮动文字（青色）
- 不会完全格挡伤害，仍然可以被击杀

**战术建议**:
- 使用高伤害武器，减少攻击次数
- 注意反伤，保持生命值健康
- 优先击杀其他敌人

---

### 2. 刺猬 (SPIKED)
**enemy_type**: `EnemyType.SPIKED`

拥有冲锋能力的敌人，会在一定距离时发动冲锋攻击。

**冲锋机制**:
- 触发距离: 100-300像素
- 冲锋流程:
  1. **预警阶段** (0.8秒): 显示红色预警线，敌人颤抖，变为红色
  2. **冲锋阶段** (0.6秒): 沿直线高速冲锋（速度x3.5）
  3. **冷却阶段** (3.0秒): 缓慢移动，无法再次冲锋

**预警线特性**:
- 宽度: 30像素（像一个长矩形区域）
- 颜色: 红色半透明
- 长度: 500像素
- 起点跟随敌人，终点固定（给玩家躲避机会）

**冲锋特性**:
- 冲锋期间免疫击退（霸体）
- 沿直线移动，不会转向
- 速度极快，难以躲避

**战术建议**:
- 看到红线立即横向移动
- 利用冷却期输出
- 不要在狭窄区域战斗

---

### 3. 剪刀手 (LINE_BREAKER)
**enemy_type**: `EnemyType.LINE_BREAKER`

能够切断玩家连线的特殊敌人（针对特定角色）。

**切线机制**:
- 每帧检测是否靠近玩家的连线
- 检测半径: 40像素
- 调用玩家的`try_break_line()`方法
- 只对拥有连线机制的角色有效（如Sapper）

**战术建议**:
- 使用连线角色时优先击杀
- 保持连线远离敌人
- 使用击退武器推开

---

## AI系统

### 状态机

敌人使用状态机控制行为，共有4种状态：

#### 1. CHASE（追逐）
**默认状态**

- 追逐玩家或嘲讽目标
- 应用群聚AI（与其他敌人保持距离）
- 到达停止距离（60像素）时停止移动
- 检测是否可以触发冲锋（仅刺猬）

#### 2. PREPARING（预警）
**仅刺猬**

- 停止移动，原地颤抖
- 显示红色预警线
- 敌人变为红色
- 持续0.8秒后进入冲锋状态

#### 3. CHARGING（冲锋）
**仅刺猬**

- 沿直线高速移动
- 免疫击退（霸体）
- 不转向，不寻路
- 持续0.6秒后进入冷却状态

#### 4. COOLDOWN（冷却）
**仅刺猬**

- 缓慢移动（速度x0.2）
- 无法再次冲锋
- 持续3.0秒后回到追逐状态

---

### 群聚AI

所有敌人都受到群聚AI影响：

**工作原理**:
1. 检测视野范围内的其他敌人
2. 计算与每个敌人的距离向量
3. 根据距离应用推力（越近推力越大）
4. 推力系数: `flock_push = 20.0`

**效果**:
- 敌人不会重叠在一起
- 形成包围圈而不是堆叠
- 更真实的群体行为

---

### 嘲讽系统

敌人支持嘲讽机制（由玩家技能触发）：

**接口**: `set_taunt_target(target: Node2D)`

**效果**:
- 强制追逐指定目标而不是玩家
- 视觉反馈: 闪烁洋红色
- 可用于引导敌人、保护玩家

---

## 波次增强

### 增强机制

每波结束后，所有敌人的属性都会增强：

**增强公式**:
```gdscript
新生命值 = 基础生命值 + (波次 - 1) × 10
新攻击力 = 基础攻击力 + (波次 - 1) × 2
```

**示例**（基础敌人）:
- 第1波: 100生命, 10攻击
- 第2波: 110生命, 12攻击
- 第3波: 120生命, 14攻击
- 第10波: 190生命, 28攻击

**影响**:
- 后期敌人更难击杀
- 需要升级武器和属性
- 增加游戏难度曲线

---

### 配置文件

敌人配置存储在: `config/enemy/enemy_config.csv`

**配置示例**:
```csv
enemy_id,display_name,health,speed,damage,attack_range,attack_cooldown,xp_value,gold_value,knockback_resistance,energy_drop,color_r,color_g,color_b
basic_enemy,基础敌人,100,150,10,50,1.0,10,5,0.5,5,,,
mine_layer,地雷怪,80,120,8,45,1.2,12,6,0.4,4,0.5,1.0,0.5
```

**修改建议**:
- 调整数值平衡游戏难度
- 添加颜色区分敌人类型
- 修改奖励影响游戏节奏

---

## 战斗技巧

### 通用技巧
1. **优先级**: 快速敌人 > 地雷怪 > 刺猬 > 基础敌人 > 坦克敌人
2. **走位**: 保持移动，避免被包围
3. **击退**: 利用击退武器控制敌人位置
4. **范围伤害**: 对付大群敌人最有效

### 针对特定敌人
- **快速敌人**: 使用范围武器，一次清理多个
- **坦克敌人**: 使用高伤害武器，避免近战
- **刺猬**: 看到红线立即横向移动
- **地雷怪**: 远程击杀，注意死亡位置
- **硬壳龟**: 高伤害武器，减少攻击次数

---

## 开发者注意事项

### 添加新敌人类型

1. 在`enemy.gd`中添加新的`EnemyType`枚举
2. 在`config/enemy/enemy_config.csv`中添加配置
3. 创建敌人场景（继承Enemy类）
4. 在`_ready()`或`_process()`中实现特殊逻辑
5. 在波次配置中添加生成规则

### 性能优化

- 敌人数量过多时考虑对象池
- 视野检测使用Area2D而不是距离计算
- 避免每帧进行复杂计算
- 使用`call_deferred()`延迟非紧急操作

### 调试技巧

- 使用`print()`输出敌人状态
- 在编辑器中调整`@export`变量
- 使用`Engine.get_frames_drawn() % 60 == 0`减少日志刷屏
- 检查`is_instance_valid()`避免访问已删除对象
