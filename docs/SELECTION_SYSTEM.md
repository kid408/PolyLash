# 角色选择与强化系统

本文档详细介绍PolyLash的角色选择界面和角色强化系统。

---

## 目录

- [系统概述](#系统概述)
- [游戏流程](#游戏流程)
- [角色选择界面](#角色选择界面)
- [角色强化界面](#角色强化界面)
- [数据持久化](#数据持久化)
- [配置说明](#配置说明)

---

## 系统概述

### 设计理念

角色选择与强化系统为玩家提供了游戏前的准备阶段：

1. **角色选择**: 选择最多3个角色组成队伍
2. **武器选择**: 为每个角色选择初始武器
3. **角色强化**: 使用金币永久提升角色属性
4. **随机武器商店**: Roguelike风格的随机武器购买

### 核心特性

- **多角色队伍**: 最多选择3个角色，游戏中可切换
- **独立武器**: 每个角色可选择不同的武器
- **永久强化**: 属性升级在游戏间保留（可配置重置）
- **金币系统**: 通过游戏获得金币，用于强化角色

---

## 游戏流程

### 完整流程图

```
游戏启动
    ↓
角色选择界面 (SelectionPanel)
    ├─ 选择角色（最多3个）
    ├─ 为每个角色选择武器
    ├─ [可选] 进入强化界面
    └─ 点击"开始游戏"
    ↓
[如果启用重置] 检查并重置属性
    ↓
进入战斗 (Arena)
    ├─ 使用选择的角色和武器
    ├─ 按1/2/3切换角色
    ├─ 击杀敌人获得金币
    └─ 游戏结束
    ↓
返回角色选择界面
    └─ 保留金币，可继续强化
```

### 流程说明

1. **角色选择阶段**
   - 从可用角色中选择1-3个角色
   - 点击角色图标选择/取消选择
   - 选中的角色显示在左侧"已选"列表

2. **武器选择阶段**
   - 点击已选角色查看可用武器
   - 为当前角色选择一把武器
   - 每个角色可选择不同武器

3. **强化阶段（可选）**
   - 点击"强化角色"按钮进入强化界面
   - 使用金币升级角色属性
   - 购买随机初始武器

4. **开始游戏**
   - 点击"开始游戏"进入战斗
   - 如果配置了重置，属性会被清空

---

## 角色选择界面

### 界面布局

```
┌─────────────────────────────────────────────────────────────┐
│                      角色选择界面                            │
├────────┬────────────────────────────────────┬───────────────┤
│        │                                    │               │
│  已选  │         角色信息面板                │   开始游戏    │
│        │  ┌──────────────────────────────┐  │               │
│  [角色1]│  │ [头像]  角色名称              │  │   强化角色    │
│  [角色2]│  │         [羁绊]               │  │               │
│  [角色3]│  │         角色描述...           │  │               │
│        │  └──────────────────────────────┘  │               │
│        │                                    │               │
│        │         选择角色                    │               │
│        │  ┌──┐ ┌──┐ ┌──┐ ┌──┐ ┌──┐        │               │
│        │  │  │ │  │ │  │ │  │ │  │ ...    │               │
│        │  └──┘ └──┘ └──┘ └──┘ └──┘        │               │
│        │                                    │               │
│        │         选择武器                    │               │
│        │  ┌──┐ ┌──┐ ┌──┐                   │               │
│        │  │  │ │  │ │  │ ...               │               │
│        │  └──┘ └──┘ └──┘                   │               │
└────────┴────────────────────────────────────┴───────────────┘
```

### 功能说明

#### 左侧面板 - 已选角色
- 显示已选择的角色（最多3个）
- 图标大小: 110x110像素
- 点击可取消选择

#### 中间区域 - 主内容
- **角色信息面板**: 显示当前选中角色的详细信息
  - 角色头像
  - 角色名称
  - 羁绊类型
  - 角色描述
- **角色选择区**: 显示所有可用角色
  - 图标大小: 120x120像素
  - 最少显示16个槽位（不足用占位符填充）
- **武器选择区**: 显示当前角色可用的武器
  - 图标大小: 60x60像素
  - 选中的武器高亮显示

#### 右侧面板 - 操作按钮
- **开始游戏**: 绿色按钮，进入战斗
- **强化角色**: 金橙色按钮，进入强化界面

### 交互逻辑

1. **选择角色**
   - 点击角色图标添加到已选列表
   - 再次点击取消选择
   - 最多选择3个角色

2. **选择武器**
   - 点击已选角色切换当前角色
   - 点击武器图标为当前角色选择武器
   - 每个角色独立保存武器选择

3. **开始游戏**
   - 检查是否选择了角色
   - 检查是否需要重置属性
   - 切换到战斗场景

---

## 角色强化界面

### 界面布局

```
┌─────────────────────────────────────────────────────────────┐
│  [返回]                              金币: 1000 [金币图标]   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  │ [头像] 角色名称  │  │ [头像] 角色名称  │  │ [头像] 角色名称  │
│  │        [羁绊]   │  │        [羁绊]   │  │        [羁绊]   │
│  │ ─────────────── │  │ ─────────────── │  │ ─────────────── │
│  │ 生命值  100 +10 │  │ 生命值  100 +10 │  │ 生命值  100 +10 │
│  │         [50金币]│  │         [50金币]│  │         [50金币]│
│  │ 能量    500 +20 │  │ 能量    500 +20 │  │ 能量    500 +20 │
│  │         [30金币]│  │         [30金币]│  │         [30金币]│
│  │ 速度    500 +15 │  │ 速度    500 +15 │  │ 速度    500 +15 │
│  │         [35金币]│  │         [35金币]│  │         [35金币]│
│  │ ...            │  │ ...            │  │ ...            │
│  │ ─────────────── │  │ ─────────────── │  │ ─────────────── │
│  │ 随机初始武器    │  │ 随机初始武器    │  │ 随机初始武器    │
│  │ [图标] 激光枪   │  │ [图标] 手枪     │  │ [图标] 拳头     │
│  │       [100金币] │  │       [已装备]  │  │       [100金币] │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 功能说明

#### 顶部栏
- **返回按钮**: 返回角色选择界面
- **金币显示**: 当前拥有的金币数量

#### 角色卡片
每个已选角色显示一个卡片，包含：

1. **头部信息**
   - 角色头像 (96x96像素)
   - 角色名称
   - 羁绊类型

2. **属性升级列表**
   - 属性名称（如"生命值"）
   - 当前数值（白色）
   - 增量预览（绿色，如"+10"）
   - 购买按钮（金币图标+价格）
   - 满级显示"MAX"（金色）

3. **随机武器商店**（如果启用）
   - 分隔线
   - 标题"随机初始武器"
   - 武器图标和名称
   - 购买按钮或"已装备"标签

### 属性升级

#### 可升级属性

| 属性 | 显示名 | 价格 | 每级增量 |
|------|--------|------|----------|
| hp | 生命值 | 50 | +10 |
| max_energy | 最大能量 | 30 | +20 |
| energy_regen | 能量恢复 | 40 | +0.2 |
| base_speed | 移动速度 | 35 | +15 |
| max_armor | 最大护甲 | 45 | +1 |

#### 升级规则
- 每个属性最多升级5级（可配置）
- 每次升级消耗固定金币
- 升级立即生效
- 满级后显示"MAX"标签

### 随机武器商店

#### 功能说明
- 为每个角色随机生成一把武器
- 每个角色的武器不同
- 购买后替换角色的初始武器
- 价格固定（默认100金币）

#### 武器池
- 排除默认武器（punch）
- 从所有可用武器中随机选择
- 显示武器图标和名称

#### 购买状态
- **未购买**: 显示购买按钮
- **已购买**: 显示"已装备"标签
- **金币不足**: 按钮禁用（灰色）

---

## 数据持久化

### 存储位置

所有数据存储在 `user://` 目录下：

| 文件 | 说明 |
|------|------|
| `player_upgrades.json` | 角色属性升级数据 |
| `player_gold.json` | 金币数量 |
| `player_selection_cache.json` | 已选角色缓存 |
| `player_weapon_cache.json` | 武器选择缓存 |
| `player_weapon_shop.json` | 随机武器商店数据 |

### 数据结构

#### player_upgrades.json
```json
{
  "butcher": {
    "hp": 3,
    "max_energy": 2,
    "base_speed": 1
  },
  "pyro": {
    "hp": 1
  }
}
```

#### player_gold.json
```json
{
  "total_gold": 1500
}
```

#### player_weapon_shop.json
```json
{
  "random_weapons": {
    "butcher": "laser",
    "pyro": "pistol"
  },
  "purchased_weapons": {
    "butcher": true
  }
}
```

### DataManager

`DataManager` 是管理所有持久化数据的单例：

#### 主要方法

| 方法 | 说明 |
|------|------|
| `get_total_gold()` | 获取当前金币 |
| `add_gold(amount)` | 增加金币 |
| `spend_gold(amount)` | 消费金币 |
| `get_upgrade_level(player_id, attr)` | 获取升级等级 |
| `do_upgrade(player_id, attr)` | 执行升级 |
| `can_upgrade(player_id, attr)` | 检查是否可升级 |
| `check_and_reset_on_new_game()` | 检查并重置属性 |
| `generate_random_weapons_for_players()` | 生成随机武器 |
| `purchase_starting_weapon(player_id)` | 购买随机武器 |

---

## 配置说明

### game_config.csv

角色选择和强化系统的相关配置：

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| selection_players_per_row | 5 | 角色选择每行显示数量 |
| max_selected_players | 3 | 最多可选角色数量 |
| max_upgrade_level | 5 | 属性最大升级等级 |
| default_gold | 1000 | 初始金币数量 |
| reset_attributes_on_new_game | 0 | 新游戏是否重置属性 (1=重置, 0=保留) |
| enable_starting_weapon_shop | 1 | 是否启用随机武器商店 (1=启用, 0=禁用) |
| starting_weapon_price | 100 | 随机武器价格 |

### attribute_upgrade.csv

属性升级配置：

| 字段 | 说明 |
|------|------|
| attribute_name | 属性ID |
| display_name | 显示名称 |
| cost | 升级价格 |
| value_increase | 每级增量 |

### Roguelike模式

当 `reset_attributes_on_new_game = 1` 时：
- 每次开始游戏重置所有属性升级
- 保留金币
- 随机武器商店重新刷新
- 购买状态清空

---

## 场景文件

### 角色选择界面
- **场景**: `res://scenes/ui/selection_panel/selection_panel.tscn`
- **脚本**: `res://scenes/ui/selection_panel/selection_panel.gd`

### 角色强化界面
- **场景**: `res://scenes/ui/selection_panel/character_upgrade.tscn`
- **脚本**: `res://scenes/ui/selection_panel/character_upgrade.gd`

### 数据管理器
- **脚本**: `res://autoloads/data_manager.gd`
- **注册**: 在 `project.godot` 中作为 Autoload

---

## 总结

角色选择与强化系统提供了完整的游戏前准备流程：

1. **灵活的角色选择**: 最多3个角色，自由组合
2. **独立的武器系统**: 每个角色可选不同武器
3. **永久的属性强化**: 金币投资，持续成长
4. **Roguelike支持**: 可配置单局重置模式

更多详细信息请查看其他文档：
- [PLAYERS.md](PLAYERS.md) - 玩家角色详解
- [WEAPONS.md](WEAPONS.md) - 武器系统
- [SYSTEMS.md](SYSTEMS.md) - 游戏系统详解
