# 武器系统详解

## 目录
- [武器类型](#武器类型)
- [武器属性](#武器属性)
- [武器升级](#武器升级)
- [武器机制](#武器机制)
- [配置说明](#配置说明)

---

## 武器类型

游戏中有两大类武器：近战武器和远程武器。

### 近战武器 (MELEE)

近战武器直接对范围内的敌人造成伤害，无需子弹。

#### 拳头 (Punch)
**weapon_id**: `punch_1` ~ `punch_4`

基础近战武器，攻击范围呈扇形，适合清理近距离敌人。

**1级属性**:
- 伤害: 20
- 精度: 1.0 (完美精度)
- 冷却: 1.5秒
- 暴击率: 5%
- 暴击伤害: 1.5倍
- 最大范围: 180像素
- 击退: 1.5
- 后坐力: 25
- 攻击时长: 0.2秒
- 返回时长: 0.15秒

**升级路径**:
- 1级 → 2级: 消耗1个物品
- 2级 → 3级: 消耗2个物品
- 3级 → 4级: 消耗3个物品
- 4级: 最终形态

**每级提升**:
- 伤害: +10 (20 → 30 → 40 → 50)
- 冷却: -0.1秒 (1.5 → 1.4 → 1.3 → 1.2)
- 暴击率: +1% (5% → 6% → 7% → 8%)
- 范围: +10像素 (180 → 190 → 200 → 210)
- 击退: +0.1 (1.5 → 1.6 → 1.7 → 1.8)

**特点**:
- 无需瞄准，自动攻击范围内敌人
- 完美精度，不会偏移
- 高击退，适合控制敌人
- 攻击速度快，适合连续输出

---

### 远程武器 (RANGE)

远程武器发射子弹攻击敌人，需要配置子弹场景。

#### 激光 (Laser)
**weapon_id**: `laser_1` ~ `laser_4`
**projectile_scene**: `res://scenes/projectiles/projectile_laser.tscn`

高精度远程武器，射速快，适合精准打击。

**1级属性**:
- 伤害: 15
- 精度: 0.95 (高精度)
- 冷却: 0.8秒
- 暴击率: 5%
- 暴击伤害: 1.5倍
- 最大范围: 300像素
- 击退: 0.5
- 后坐力: 20
- 子弹速度: 2000
- 攻击时长: 0.15秒
- 返回时长: 0.15秒

**升级路径**:
- 1级 → 2级: 消耗1个物品
- 2级 → 3级: 消耗2个物品
- 3级 → 4级: 消耗3个物品
- 4级: 最终形态

**每级提升**:
- 伤害: +7~8 (15 → 22 → 30 → 40)
- 冷却: -0.05秒 (0.8 → 0.75 → 0.7 → 0.65)
- 精度: +0.01 (0.95 → 0.96 → 0.97 → 0.98)
- 范围: +20像素 (300 → 320 → 340 → 360)
- 击退: +0.1 (0.5 → 0.6 → 0.7 → 0.8)
- 子弹速度: +100 (2000 → 2100 → 2200 → 2300)

**特点**:
- 射速最快（0.8秒冷却）
- 高精度，适合远程狙击
- 子弹速度快，难以躲避
- 低击退，不适合控制

---

#### 手枪 (Pistol)
**weapon_id**: `pistol_1` ~ `pistol_4`
**projectile_scene**: `res://scenes/projectiles/projectile_pistol.tscn`

平衡型远程武器，伤害和射速都较为均衡。

**1级属性**:
- 伤害: 25
- 精度: 0.9 (中等精度)
- 冷却: 1.0秒
- 暴击率: 5%
- 暴击伤害: 1.5倍
- 最大范围: 250像素
- 击退: 1.0
- 后坐力: 30
- 子弹速度: 1600
- 攻击时长: 0.2秒
- 返回时长: 0.15秒

**升级路径**:
- 1级 → 2级: 消耗1个物品
- 2级 → 3级: 消耗2个物品
- 3级 → 4级: 消耗3个物品
- 4级: 最终形态

**每级提升**:
- 伤害: +10 (25 → 35 → 45 → 55)
- 冷却: -0.05秒 (1.0 → 0.95 → 0.9 → 0.85)
- 精度: +0.01 (0.9 → 0.91 → 0.92 → 0.93)
- 范围: +20像素 (250 → 270 → 290 → 310)
- 击退: +0.1 (1.0 → 1.1 → 1.2 → 1.3)
- 子弹速度: +100 (1600 → 1700 → 1800 → 1900)

**特点**:
- 伤害高于激光
- 精度略低，适合中距离
- 击退适中，可以控制敌人
- 平衡的全能武器

---

## 武器属性

### 核心属性说明

| 属性 | 说明 | 影响 |
|------|------|------|
| damage | 伤害 | 对敌人造成的基础伤害 |
| accuracy | 精度 | 0.0-1.0，越高越准确 |
| cooldown | 冷却 | 两次攻击之间的间隔（秒） |
| crit_chance | 暴击率 | 0.0-1.0，触发暴击的概率 |
| crit_damage | 暴击伤害 | 暴击时的伤害倍率 |
| max_range | 最大范围 | 武器的攻击范围（像素） |
| knockback | 击退 | 击退敌人的力度 |
| life_steal | 生命窃取 | 伤害转化为生命值的比例 |
| recoil | 后坐力 | 攻击时的视觉反馈 |
| recoil_duration | 后坐力时长 | 后坐力动画持续时间 |
| attack_duration | 攻击时长 | 攻击动画持续时间 |
| back_duration | 返回时长 | 返回动画持续时间 |
| projectile_speed | 子弹速度 | 仅远程武器，子弹飞行速度 |

---

### 精度系统

精度影响武器的射击偏移：

**计算公式**:
```gdscript
weapon_spread = randf_range(-1 + accuracy, 1 - accuracy)
```

**示例**:
- 精度1.0: 偏移范围 [0, 0]，完全准确
- 精度0.95: 偏移范围 [-0.05, 0.05]，轻微偏移
- 精度0.9: 偏移范围 [-0.1, 0.1]，中等偏移
- 精度0.5: 偏移范围 [-0.5, 0.5]，大幅偏移

**影响**:
- 近战武器通常精度1.0（无偏移）
- 远程武器精度0.9-0.98（有偏移）
- 精度越低，远距离越难命中

---

### 暴击系统

暴击系统增加伤害的随机性和爆发力：

**触发条件**:
```gdscript
if randf() < crit_chance:
    damage *= crit_damage
```

**示例**:
- 暴击率5%，暴击伤害1.5倍
- 基础伤害20，暴击伤害30
- 平均每20次攻击触发1次暴击

**升级影响**:
- 每级暴击率+1%
- 暴击伤害固定1.5倍（可通过玩家属性提升）

---

## 武器升级

### 升级系统

武器可以通过消耗物品升级，最高4级。

**升级消耗**:
- 1级 → 2级: 1个物品
- 2级 → 3级: 2个物品
- 3级 → 4级: 3个物品
- 总计: 6个物品达到满级

**升级途径**:
1. 击杀敌人掉落物品
2. 波次结束宝箱奖励
3. 商店购买（如果有）

**升级建议**:
- 优先升级主武器
- 平衡升级多个武器
- 根据敌人类型选择武器

---

### 升级对比

#### 拳头升级对比
| 等级 | 伤害 | 冷却 | 暴击率 | 范围 | 击退 | 消耗 |
|------|------|------|--------|------|------|------|
| 1级 | 20 | 1.5s | 5% | 180 | 1.5 | - |
| 2级 | 30 | 1.4s | 6% | 190 | 1.6 | 1 |
| 3级 | 40 | 1.3s | 7% | 200 | 1.7 | 2 |
| 4级 | 50 | 1.2s | 8% | 210 | 1.8 | 3 |

**总提升**: 伤害+150%, 冷却-20%, 暴击率+60%, 范围+17%, 击退+20%

#### 激光升级对比
| 等级 | 伤害 | 冷却 | 精度 | 范围 | 子弹速度 | 消耗 |
|------|------|------|------|------|----------|------|
| 1级 | 15 | 0.8s | 0.95 | 300 | 2000 | - |
| 2级 | 22 | 0.75s | 0.96 | 320 | 2100 | 1 |
| 3级 | 30 | 0.7s | 0.97 | 340 | 2200 | 2 |
| 4级 | 40 | 0.65s | 0.98 | 360 | 2300 | 3 |

**总提升**: 伤害+167%, 冷却-19%, 精度+3%, 范围+20%, 子弹速度+15%

#### 手枪升级对比
| 等级 | 伤害 | 冷却 | 精度 | 范围 | 子弹速度 | 消耗 |
|------|------|------|------|------|----------|------|
| 1级 | 25 | 1.0s | 0.9 | 250 | 1600 | - |
| 2级 | 35 | 0.95s | 0.91 | 270 | 1700 | 1 |
| 3级 | 45 | 0.9s | 0.92 | 290 | 1800 | 2 |
| 4级 | 55 | 0.85s | 0.93 | 310 | 1900 | 3 |

**总提升**: 伤害+120%, 冷却-15%, 精度+3%, 范围+24%, 子弹速度+19%

---

## 武器机制

### 目标选择

武器自动选择最近的敌人攻击：

**选择流程**:
1. 检测范围内的所有敌人（通过Area2D）
2. 计算每个敌人到武器的距离
3. 选择距离最近的敌人作为目标
4. 旋转武器朝向目标

**特殊情况**:
- 无目标时，武器朝向玩家面向方向
- 攻击中不更新目标（锁定）
- 目标死亡或离开范围时重新选择

---

### 攻击流程

武器攻击分为多个阶段：

**1. 冷却检测**:
- 检查冷却计时器是否结束
- 检查是否有有效目标
- 满足条件才能攻击

**2. 计算偏移**:
- 根据精度计算射击偏移
- 应用偏移到武器旋转

**3. 执行攻击**:
- 近战: 直接对范围内敌人造成伤害
- 远程: 生成子弹实例

**4. 启动冷却**:
- 启动冷却计时器
- 等待下次攻击

---

### 近战攻击

近战武器使用HitboxComponent直接造成伤害：

**工作原理**:
1. 武器范围内的敌人进入Area2D
2. 攻击时，HitboxComponent对所有范围内敌人造成伤害
3. 应用击退效果
4. 播放攻击动画

**优点**:
- 无需瞄准
- 可以同时攻击多个敌人
- 立即生效，无延迟

**缺点**:
- 范围有限
- 需要接近敌人
- 容易受到反伤

---

### 远程攻击

远程武器生成子弹实例：

**工作原理**:
1. 实例化子弹场景（projectile_scene）
2. 设置子弹位置和方向
3. 设置子弹速度和伤害
4. 子弹飞行并检测碰撞
5. 命中敌人时造成伤害

**优点**:
- 安全距离攻击
- 可以攻击远处敌人
- 子弹可以穿透（如果配置）

**缺点**:
- 需要瞄准
- 子弹可能miss
- 有飞行时间

---

### 视觉反馈

武器攻击有丰富的视觉反馈：

**旋转**:
- 武器始终朝向目标
- 攻击时锁定方向
- 无目标时朝向玩家面向方向

**翻转**:
- 根据旋转角度翻转sprite
- 避免武器倒置显示

**后坐力**:
- 攻击时武器后退
- 后退距离由recoil决定
- 动画时长由recoil_duration决定

**动画**:
- 攻击动画: attack_duration
- 返回动画: back_duration
- 流畅的攻击循环

---

## 配置说明

### 配置文件

武器配置存储在: `config/weapon/weapon_stats_config.csv`

**配置示例**:
```csv
weapon_id,display_name,damage,accuracy,cooldown,crit_chance,crit_damage,max_range,knockback,life_steal,recoil,recoil_duration,attack_duration,back_duration,projectile_speed,weapon_scene,projectile_scene,upgrade_to,item_cost,icon_path
punch_1,拳头1级,20.0,1.0,1.5,0.05,1.5,180.0,1.5,0.0,25.0,0.1,0.2,0.15,0.0,res://scenes/weapons/melee/weapon_punch.tscn,,punch_2,1,res://assets/sprites/Weapons/Icons/weapon_punch_icon.png
laser_1,激光1级,15.0,0.95,0.8,0.05,1.5,300.0,0.5,0.0,20.0,0.1,0.15,0.15,2000.0,res://scenes/weapons/range/weapon_laser.tscn,res://scenes/projectiles/projectile_laser.tscn,laser_2,1,res://assets/sprites/Weapons/Icons/weapon_laser_icon.png
```

---

### 添加新武器

**步骤**:
1. 在CSV中添加新行，配置所有属性
2. 创建武器场景（继承Weapon类）
3. 如果是远程武器，创建子弹场景
4. 设置武器图标
5. 配置升级路径（upgrade_to列）
6. 在玩家配置中添加初始武器

**注意事项**:
- weapon_id必须唯一
- 远程武器必须配置projectile_scene
- 升级路径形成链条（1→2→3→4）
- 最高级武器upgrade_to留空
- 所有路径必须正确（场景、图标）

---

### 平衡调整

**伤害平衡**:
- 近战伤害高于远程（补偿风险）
- 射速快的武器伤害低
- 考虑DPS（伤害/冷却）

**范围平衡**:
- 近战范围小（180-210）
- 远程范围大（250-360）
- 范围影响安全性

**精度平衡**:
- 近战完美精度（1.0）
- 远程有偏移（0.9-0.98）
- 精度影响远距离命中率

**升级平衡**:
- 每级提升明显但不过分
- 消耗递增（1→2→3）
- 满级武器强大但需要投入

---

## 战斗技巧

### 武器选择

**对付快速敌人**:
- 推荐: 激光（射速快）
- 避免: 手枪（精度低）

**对付坦克敌人**:
- 推荐: 手枪（伤害高）
- 避免: 激光（伤害低）

**对付大群敌人**:
- 推荐: 拳头（范围攻击）
- 避免: 远程武器（单体）

**对付刺猬**:
- 推荐: 远程武器（安全距离）
- 避免: 拳头（容易被冲锋）

---

### 升级策略

**前期**:
- 升级主武器到2级
- 保持多样性

**中期**:
- 主武器升到3级
- 副武器升到2级

**后期**:
- 主武器满级
- 多个武器3-4级

---

### 组合搭配

**近战+远程**:
- 远程清理远处敌人
- 近战应对近身敌人
- 平衡的组合

**双远程**:
- 保持安全距离
- 适合脆弱角色
- 需要走位技巧

**双近战**:
- 高伤害输出
- 适合坦克角色
- 风险较高

---

## 开发者注意事项

### 性能优化

- 子弹使用对象池
- 限制同时存在的子弹数量
- 及时清理离开屏幕的子弹
- 使用Area2D而不是距离检测

### 调试技巧

- 在编辑器中调整@export变量
- 使用print()输出攻击信息
- 检查子弹场景路径是否正确
- 验证CSV配置是否加载

### 常见问题

**子弹不生成**:
- 检查projectile_scene路径
- 确认子弹场景存在
- 检查CSV是否正确加载

**武器不攻击**:
- 检查冷却计时器
- 确认有有效目标
- 检查范围设置

**伤害不正确**:
- 确认CSV配置正确
- 检查暴击计算
- 验证敌人护甲

**武器不旋转**:
- 检查目标选择逻辑
- 确认旋转计算
- 验证sprite设置
