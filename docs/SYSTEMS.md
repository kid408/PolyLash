# 游戏系统详解

本文档详细介绍PolyLash中的各个游戏系统。

---

## 目录

- [波次系统](#波次系统)
- [宝箱系统](#宝箱系统)
- [属性升级系统](#属性升级系统)
- [音效系统](#音效系统)
- [打击感系统](#打击感系统)
- [地图系统](#地图系统)
- [UI系统](#ui系统)

---

## 波次系统

### 概述

波次系统是游戏的核心玩法机制，玩家需要在限定时间内对抗不断生成的敌人。

### 波次配置

波次配置位于 `config/wave/wave_config.csv`：

| 字段 | 说明 | 示例 |
|------|------|------|
| wave_id | 波次ID | wave_1_to_5 |
| from_wave | 起始波次 | 1 |
| to_wave | 结束波次 | 5 |
| wave_time | 波次时长（秒） | 20.0 |
| spawn_type | 生成类型 | RANDOM |
| fixed_spawn_time | 固定生成间隔 | 1.0 |
| min_spawn_time | 最小生成间隔 | 0.8 |
| max_spawn_time | 最大生成间隔 | 1.5 |

### 敌人生成规则

敌人生成配置位于 `config/wave/wave_units_config.csv`：

- **wave_id**: 对应的波次ID
- **enemy_scene**: 敌人场景路径
- **weight**: 生成权重（权重越高，生成概率越大）

示例：
```csv
wave_id,enemy_scene,weight
wave_1_to_5,res://scenes/unit/enemy/enemy_chaser_slow.tscn,3.0
wave_1_to_5,res://scenes/unit/enemy/enemy_chaser_mid.tscn,2.0
```

### 生成机制

1. **动态生成**: 敌人在玩家附近动态生成（距离玩家200-800像素）
2. **权重系统**: 根据配置的权重随机选择敌人类型
3. **生成间隔**: 根据配置的时间间隔生成敌人
4. **波次切换**: 时间到达后自动进入下一波

### 调试功能

- 按 **L键** 可立即进入下一波（跳过当前波次剩余时间）

---

## 宝箱系统

### 概述

宝箱系统提供属性升级，是玩家变强的主要途径。

### 宝箱等级

游戏中有4个品质等级的宝箱：

| 等级 | 名称 | 指示器颜色 | 属性数量 | 生成权重 |
|------|------|-----------|---------|---------|
| 1 | 木宝箱 | 白色 | 3 | 60% |
| 2 | 青铜宝箱 | 绿色 | 3 | 25% |
| 3 | 黄金宝箱 | 蓝色 | 3 | 12% |
| 4 | 钻石宝箱 | 紫色 | 3 | 3% |

### 宝箱生成规则

宝箱生成配置位于 `config/wave/wave_chest_config.csv`：

| 字段 | 说明 |
|------|------|
| wave_range_start | 波次起始 |
| wave_range_end | 波次结束 |
| min_tier | 最小宝箱等级 |
| max_tier | 最大宝箱等级 |
| chest_count | 宝箱数量 |
| spawn_interval | 生成间隔（秒） |

示例：
```csv
wave_range_start,wave_range_end,min_tier,max_tier,chest_count,spawn_interval
1,3,1,2,3,30
4,6,2,3,4,25
```

### 生成机制

1. **定时生成**: 根据配置的间隔时间生成宝箱
2. **随机位置**: 在玩家附近随机位置生成（500-2000像素）
3. **最小距离**: 宝箱之间保持最小距离（500像素），避免重叠
4. **等级范围**: 根据当前波次决定宝箱等级范围

### 宝箱指示器

- **屏幕边缘箭头**: 指向屏幕外的宝箱
- **颜色区分**: 不同等级的宝箱有不同的指示器颜色
- **距离显示**: 显示宝箱距离玩家的距离

### 打开宝箱

1. 玩家触碰宝箱自动打开
2. 显示3个随机属性升级选项
3. 选择一个属性进行升级
4. 升级立即生效

---

## 属性升级系统

### 概述

属性升级系统允许玩家通过宝箱提升角色能力。

### 可升级属性

配置位于 `config/item/upgrade_attributes.csv`：

#### 基础属性

| 属性ID | 显示名称 | 描述 | 数值类型 |
|--------|---------|------|---------|
| max_health | 最大生命值 | 增加生命上限 | flat |
| max_energy | 最大能量值 | 增加能量上限 | flat |
| energy_regen | 能量恢复 | 每秒恢复能量 | flat |
| base_speed | 移动速度 | 提升移动速度 | flat |

#### 冲刺属性

| 属性ID | 显示名称 | 描述 | 数值类型 |
|--------|---------|------|---------|
| dash_distance | 冲刺距离 | 增加冲刺距离 | flat |
| dash_damage | 冲刺伤害 | 增加冲刺伤害 | flat |
| dash_cost | 冲刺消耗 | 减少冲刺能量消耗 | flat |

#### 技能属性

| 属性ID | 显示名称 | 描述 | 数值类型 |
|--------|---------|------|---------|
| skill_q_damage | Q技能伤害 | 增加Q技能伤害 | percent |
| skill_q_cost | Q技能消耗 | 减少Q技能能量消耗 | flat |
| skill_e_damage | E技能伤害 | 增加E技能伤害 | percent |
| skill_e_cost | E技能消耗 | 减少E技能能量消耗 | flat |

#### 战斗属性

| 属性ID | 显示名称 | 描述 | 数值类型 |
|--------|---------|------|---------|
| weapon_damage | 武器伤害 | 增加所有武器伤害 | percent |
| weapon_range | 武器范围 | 增加武器攻击范围 | flat |
| crit_chance | 暴击率 | 增加暴击概率 | percent |
| crit_damage | 暴击伤害 | 增加暴击伤害倍率 | percent |
| damage_reduction | 伤害减免 | 减少受到的伤害 | percent |
| lifesteal | 生命偷取 | 攻击恢复生命 | percent |
| energy_on_kill | 击杀回能 | 击杀敌人恢复能量 | flat |

### 升级等级

每个属性有4个升级等级，对应4个宝箱品质：

- **Tier 1** (木宝箱): 基础提升
- **Tier 2** (青铜宝箱): 中等提升（约2.5倍）
- **Tier 3** (黄金宝箱): 高级提升（约6倍）
- **Tier 4** (钻石宝箱): 顶级提升（约15倍）

### 数值类型

- **flat**: 固定数值增加（如 +10 生命值）
- **percent**: 百分比增加（如 +5% 武器伤害）

### 升级反馈

- **立即生效**: 属性升级后立即应用到角色
- **UI更新**: 生命条、能量条等UI实时更新
- **控制台日志**: 显示详细的升级信息

---

## 音效系统

### 概述

音效系统提供游戏中的所有音效播放和管理。

### 音效配置

配置位于 `config/system/sound_config.csv`：

| 字段 | 说明 | 示例 |
|------|------|------|
| sound_id | 音效ID | player_attack |
| sound_path | 音效文件路径 | res://assets/audio/player_attack.wav |
| volume_db | 音量（分贝） | 0.0 |
| min_pitch | 最小音调 | 0.9 |
| max_pitch | 最大音调 | 1.1 |
| description | 描述 | 玩家普通攻击 |

### 音效类型

#### 玩家音效

- **player_attack**: 玩家普通攻击
- **player_hit**: 玩家受击
- **player_dash**: 玩家冲刺
- **player_skill_q**: 玩家Q技能
- **player_skill_e**: 玩家E技能
- **player_death**: 玩家死亡

#### 敌人音效

- **enemy_attack**: 敌人攻击
- **enemy_death**: 敌人死亡
- **enemy_hit**: 敌人受击

### 音效特性

1. **随机音调**: 每次播放时在min_pitch和max_pitch之间随机选择音调
2. **音量控制**: 通过volume_db控制音量大小
3. **对象池**: 使用对象池优化性能，避免频繁创建销毁
4. **容错处理**: 音效文件不存在时不会崩溃，只输出警告

### 使用方法

```gdscript
# 播放音效
SoundManager.play_sound("player_attack")

# 播放音效（指定位置）
SoundManager.play_sound_at_position("enemy_death", enemy_position)
```

---

## 打击感系统

### 概述

打击感系统通过多种反馈机制提供爽快的战斗体验。

### 反馈机制

#### 1. 顿帧效果

- **原理**: 短暂降低游戏时间流速
- **触发时机**: 攻击命中、受击、敌人死亡
- **参数**:
  - `duration`: 顿帧持续时间（秒）
  - `time_scale`: 时间缩放比例（0.0-1.0）

示例：
```gdscript
# 轻微顿帧
Global.frame_freeze(0.03, 0.2)  # 0.03秒，时间流速20%

# 强烈顿帧
Global.frame_freeze(0.08, 0.15)  # 0.08秒，时间流速15%
```

#### 2. 屏幕震动

- **原理**: 摄像机随机偏移
- **触发时机**: 攻击命中、受击、爆炸
- **参数**:
  - `strength`: 震动强度（像素）
  - `duration`: 震动持续时间（秒）

示例：
```gdscript
# 轻微震动
Global.on_camera_shake.emit(5.0, 0.1)

# 强烈震动
Global.on_camera_shake.emit(10.0, 0.25)
```

#### 3. 音效反馈

- **触发时机**: 所有重要动作
- **特性**: 随机音调变化，增加丰富度

#### 4. 视觉反馈

- **闪白效果**: 受击时精灵闪白
- **粒子效果**: 攻击、死亡时的粒子
- **飘字提示**: 伤害数字、状态文字

### 反馈强度分级

#### 玩家受击

- **护甲破碎**: 轻微震动（4.0强度）+ 轻微顿帧（0.03秒）
- **无护甲受伤**: 强烈震动（10.0强度）+ 明显顿帧（0.08秒）

#### 敌人受击

- **普通伤害**: 根据伤害大小调整反馈强度
- **高伤害（≥50）**: 中等震动 + 中等顿帧
- **超高伤害（≥200）**: 强烈震动 + 明显顿帧

#### 敌人死亡

- **增强反馈**: 比受击更强的震动和顿帧
- **音效**: 专门的死亡音效

---

## 地图系统

### 概述

地图系统提供无限的游戏空间，玩家可以自由探索。

### 地图配置

配置位于 `config/system/map_config.csv`：

| 字段 | 说明 | 默认值 |
|------|------|--------|
| map_width | 地图宽度（像素） | 2000 |
| map_height | 地图高度（像素） | 2000 |
| arena_radius | 竞技场半径 | 800 |
| boundary_damage | 边界伤害 | 10 |
| boundary_knockback | 边界击退力度 | 500 |
| spawn_safe_radius | 生成安全半径 | 200 |
| map_tile_size | 地图瓦片大小 | 2000 |
| chest_spawn_density | 宝箱生成密度 | 10 |
| chest_spawn_radius | 宝箱生成半径 | 2000 |
| background_extend_threshold | 背景扩展阈值 | 1000 |
| indicator_show_range | 指示器显示范围 | 3000 |

### 无限地图

- **动态平铺**: 背景瓦片根据玩家位置动态生成
- **无缝衔接**: 瓦片之间无缝连接
- **性能优化**: 只渲染可见区域的瓦片

### 边界系统

- **软边界**: 玩家可以超出竞技场范围，但会受到伤害和击退
- **边界伤害**: 每秒造成固定伤害
- **边界击退**: 将玩家推回竞技场内

---

## UI系统

### 概述

UI系统提供游戏中的所有用户界面元素。

### UI元素

#### 1. 生命条

- **位置**: 单位头顶
- **显示**: 当前生命值 / 最大生命值
- **颜色**: 
  - 玩家: 粉红色
  - 敌人: 红色
- **动画**: 平滑过渡

#### 2. 能量条

- **位置**: 屏幕左上角（血条下方）
- **显示**: 当前能量 / 最大能量
- **颜色**: 青色
- **实时更新**: 能量变化时立即更新

#### 3. 波次UI

- **位置**: 屏幕顶部中央
- **显示**: 
  - 当前波次 / 总波次
  - 剩余时间
- **颜色**: 白色

#### 4. 宝箱指示器

- **位置**: 屏幕边缘
- **显示**: 
  - 箭头指向宝箱方向
  - 宝箱距离
- **颜色**: 根据宝箱等级变化
- **显示条件**: 宝箱在屏幕外且距离小于3000像素

#### 5. 飘字系统

- **伤害数字**: 显示造成的伤害
- **状态文字**: 显示特殊状态（如"BLOCK!"、"SHIELD!"）
- **颜色区分**: 
  - 伤害: 白色/黄色/橙色（根据大小）
  - 治疗: 绿色
  - 能量: 青色
  - 状态: 黄色

### UI更新机制

- **信号驱动**: 使用Godot信号系统更新UI
- **实时更新**: 数值变化时立即更新UI
- **平滑动画**: 使用Tween实现平滑过渡

---

## 总结

PolyLash的游戏系统设计注重：

1. **可配置性**: 所有数据通过CSV配置，易于调整
2. **模块化**: 各系统独立，易于维护和扩展
3. **反馈丰富**: 多种反馈机制，提供良好的游戏体验
4. **性能优化**: 对象池、动态加载等优化手段

更多详细信息请查看其他文档：
- [PLAYERS.md](PLAYERS.md) - 玩家角色系统
- [ENEMIES.md](ENEMIES.md) - 敌人系统
- [WEAPONS.md](WEAPONS.md) - 武器系统
- [WAVES.md](WAVES.md) - 波次系统
